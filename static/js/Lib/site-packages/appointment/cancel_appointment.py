import jquery
from browser import window
import json
jq=window.jQuery

class CancellationResponse:
    def __init__(self, status=None,message=None, *args, **kwargs) -> None:
        self.status=status
        self.message=message
class CancelAppointment:
    def __init__(self,reference_codes=[]) -> None:
        self.reference_codes=reference_codes
        self.__cb=None
        self.__url='/modules/api_cable/cancel_appointment_cable.php'
    def connection_error(self,res,status,xhr):
        if self.__cb is not None:
            self.__cb(CancellationResponse(
              status='error',
              message='Network connection error'  
            ))
    def connection_ok(self,res,status,xhr):
        if status=='success':
        
            js=json.loads(res)

            if js['status']=='success':
                if self.__cb is not None:
                    self.__cb(CancellationResponse(
                        status='success',
                        message='Successfully cancelled'
                    ))
            elif js['status'] == 'failed':
                if self.__cb is not None:
                    self.__cb(CancellationResponse(
                        status='failed',
                        message=js['message']
                    ))
            elif js['status'] == 'error':
                if self.__cb is not None:
                    self.__cb(CancellationResponse(
                        status='error',
                        message=js['message']
                    ))
        else:
            if self.__cb is not None:
                self.__cb(CancellationResponse(
                    status='error',
                    message='Network connection error'
                ))
    def process(self,cb):
        if len(self.reference_codes) == 0:
            cb(CancellationResponse(
                status='failed',
                message='Please add an item'
            ))
        else:
            self.__cb=cb
            data={
                'cancel_appointment':'ok',
                'reference_codes':self.reference_codes
            }
            jq.post(self.__url,data,self.connection_ok).fail(self.connection_error)
