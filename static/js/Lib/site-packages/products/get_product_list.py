import jquery
from browser import window, alert,confirm
jq=window.jQuery
import json
import datatables
from products.delete_product import DeleteProduct,DeleteProductResponse
from utils.loader import Loader
from products.service_card import ServiceCard
class GetProductList:
    def __init__(self,datatable_element) -> None:
        self.cable='/modules/api_cable/get_service_list_cable.php'
        self.datatable_element= datatable_element
        self.current_table= jq(self.datatable_element).DataTable()
        self.loader=Loader()
    
    def delete_confirm(self,e):
        target=jq(e.target)
        conf=confirm('Delete Product {product_name} ?'.format(product_name=target.attr('product_name')))
        if conf:
            api_delete=DeleteProduct()
            api_delete.on_load(self.delete_product_response)
            self.loader.show_loader()
            api_delete.process_delete(int(target.attr('product_id')))
    def delete_product_response(self,prod_res:DeleteProductResponse):
        alert(prod_res.message)
        self.loader.close_loader()
        if prod_res.status == 'success':
            self.loader.show_loader()
            window.location.reload()
        
    def delete_button_load(self):
        jq('.delete_product').unbind('click')
        jq('.delete_product').bind('click',self.delete_confirm)
    def datatable_finish(self,e,x):
        self.delete_button_load()
        self.loader.close_loader()
    def on_loaded_data(self,res,status,xhr):
        if status=='success':
            try:
                js=json.loads(res)
                if js['status'] == 'success':
                    self.current_table.destroy()
                    data=js['data']
                    i=0
                    list=[]
                    for x in data:
                        x_data=[]
                        x_data.append("<div class='div_td'>{item}</div>".format(item= i+1))
                        image_data="data:{file_content_type};base64, {file_content}".format(
                            file_content_type=x['file_content_type'],
                            file_content= x['file_content']
                        )
                        img_src="<img src='{image_data}' width='25px' height='25px' alt='product_img'/>".format(image_data = image_data)

                        x_data.append("<div class='div_td'>{item}</div>".format(item= img_src))
                        x_data.append( "<div class='div_td'>{item}</div>".format(item= x['product_name']))
                        x_data.append("<div class='div_td'>{item}</div>".format( item= x['product_code']))
                        x_data.append("<div class='div_td'>{item}</div>".format(item= x['class_name']))
                        edit_link="<a href='/products/{product_code}/edit'><img src=\"static/images/edit.png\"></a>".format(product_code = x['product_code'])
                        delete_link="<a href='#' product_id='{service_id}' product_name='{product_name}' class='delete_product'>&times;</a>".format(service_id=x['service_id'], product_name=x['product_name'])
                        div_actions="<div class='action_button'>{edit_link} &nbsp; {delete_link} </div>".format(edit_link= edit_link,
                        delete_link= delete_link)

                        x_data.append("<div class='div_td'>{item}</div>".format(item= div_actions))
                        list.append(x_data)
                        i+=1
                    self.current_table=jq(self.datatable_element).DataTable({
                        'data':list
                    })
                    self.current_table.on('draw',self.datatable_finish)
                    self.current_table.draw()
                else:
                    alert(js['message'])
            except:
                alert('Unknown error, Please try again')
        else:
            alert('Connection to the server not established')
    
    def on_error_load(self,res,status,xhr):
        self.loader.close_loader()
        alert('Connection to the server not established')
    
    def load(self):
        data={
            'get_services':'ok'
        }
        self.loader.show_loader()
        jq.post(self.cable,data,self.on_loaded_data).fail(self.on_error_load)


class GetProductListGallery:
    def __init__(self, element) -> None:
        self.cable='/modules/api_cable/get_service_list_cable.php'
        self.element=jq(element)
        self.loader=Loader()
    def service_card_load_complete(self,service_card:ServiceCard,service_list):
        self.loader.close_loader()
        for x in service_list:
          
            card=jq(service_card.create_card(x['product_name'],x['product_code'], x['file_content_type'], x['file_content']))
            #print(card)
           
            self.element.append(card)

    def on_load_ok(self,res,status,xhr):
        self.loader.close_loader()
        if status=='success':
            try:
                js=json.loads(res)
                if js['status'] == 'success':
                    service= ServiceCard()
                    self.loader.show_loader()
                    service.get_service_card(lambda s, service_list=js['data']:self.service_card_load_complete(s,service_list))
                else:
                    alert(js['message'])
            except:
                alert('Parse error')
        else:
            alert('Connection to the server not established')
    def on_load_failed(self,res,status,xhr):
        self.loader.close_loader()
        alert('Connection to the server not established')
    def load(self):
        self.element.html("")
        self.loader.show_loader()
        data={
            'get_services':'ok'
        }
        jq.post(self.cable, data, self.on_load_ok).fail(self.on_load_failed)
      
      